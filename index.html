<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Election Heatmap</title>
    <link href="gmapstyle.css" rel="stylesheet">
    <link href="bootstrap.css" rel="stylesheet">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=visualization"></script>

    <script type="text/javascript">
        document.write('<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markermanager/src/markermanager.js"><'+'/script>');
    </script>
    <script>


var map, pointarray, heatmap;
var heatmaps = {};
var defaultzoom = 4;
var defaultcentre = new google.maps.LatLng(-28.75,133.70);


function initialize() {
  var mapOptions = {
    zoom: defaultzoom,
    center: defaultcentre,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);
	  
  manager = new MarkerManager(map);
  infowindow = new google.maps.InfoWindow({ content: "holding..."});


  loadParty("ALP", true);
  loadParty("GRN");
  loadParty("LP");
  loadParty("LNP");
  loadParty("NP");
  loadParty("PUP");

  toggleHeatmapParty("ALP");

  $(".partychange").click(function(){
	toggleHeatmapParty($(this).attr("value"));
   });
   
   $('#title').click(function(){
		revertMap();
	});	
   
   loadBooths();



}

function loadParty(party, show){

  if(!party) return;

  var data = $.getJSON('./data/' + party + '.json', function(json) {

	var partydata = [];

	for (var i=0; i < json.data.length; i++){
		var line = {location: new google.maps.LatLng( json.data[i].lat, json.data[i].lng), weight: json.data[i].count}	;
		partydata.push(line);	
	}

	
	  var gradient = [
    'rgba(0, 255, 255, 0)',
    'rgba(0, 255, 255, 1)',
    'rgba(0, 127, 255, 1)',
    'rgba(0, 63, 255, 1)',
    'rgba(0, 0, 255, 1)',
    'rgba(0, 0, 191, 1)',
    'rgba(0, 0, 159, 1)',
    'rgba(0, 0, 127, 1)',
    'rgba(127, 0, 63, 1)',
    'rgba(191, 0, 31, 1)',
    'rgba(255, 0, 0, 1)'
  ];
  

  
  
	heatmaps[party] = new google.maps.visualization.HeatmapLayer({
	   data: partydata ,
       opactity: 0.9,
	   maxIntensity: json.max,
	   radius: 20,
	   gradient: gradient,
	   dissipating: true 
	});

	if(show){
		heatmaps[party].setMap(map);
	}
	
  });
}

function revertMap(){
	map.setZoom(defaultzoom);
	map.setCenter(defaultcentre);
}


function toggleHeatmapParty(party){

	$.each(heatmaps, function(key, value){
		if (key == party){
			value.setMap(map);
		}
		else{
			value.setMap(null);
		}
	});

	// and highlight the button
	$("button.partychange").removeClass("btn-info");
	$("button.partychange[value='" + party + "']").addClass("btn-info");
}


function loadBooths(){
    $.getJSON("./data/booths.json", function(results){
	for (var i = 0; i < results.features.length; i++) {
	
		// build the html from the candidates properties
		var whtml =  "<h3>"+ results.features[i].properties.name + "</h3>";

		if(results.features[i].properties.candidates){
			for (var x=0; x < results.features[i].properties.candidates.length; x++){
				whtml+= "<p>" + results.features[i].properties.candidates[x] + "</p>";		
			}
		}

 		var coords = results.features[i].geometry.coordinates;
   		var latLng = new google.maps.LatLng(coords[1], coords[0]);
    		var marker = new google.maps.Marker({
      			position: latLng,
	   			title : results.features[i].properties.name,
			    html : whtml
			});
		google.maps.event.addListener(marker, 'click', function(){
			infowindow.setContent(this.html);
			infowindow.open(map, this);
		});

		manager.addMarker(marker, 13);

	} 			
	manager.refresh();
    });	
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>

  <body>

<div class="navbar navbar-inverse navbar-fixed-static">
  <div class="navbar-inner">
    <a class="brand" id='title' href='#'>Election Heatmap</a>
      <button class="partychange btn" value="ALP">ALP</button>
      <button class="partychange btn" value="GRN">Greens</button>
      <button class="partychange btn" value="LP">Liberal</button>
      <button class="partychange btn" value="LNP">LNP</button>
      <button class="partychange btn" value="NP">National</button>
      <button class="partychange btn" value="PUP">Palmer</button>
      <span class="pull-right"><a class="brand" href="http://twitter.com/peterneish">@peterneish</a></span>
  </div>
</div>
    <div id="map-canvas"></div>
  </body>
</html>
