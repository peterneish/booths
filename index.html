<!DOCTYPE html>
<html>
  <head>
    <meta charset="utf-8">
    <title>Election Heatmap</title>
    <link href="gmapstyle.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link href="bootstrap/css/bootstrap-responsive.min.css" rel="stylesheet">
    <script src="http://ajax.googleapis.com/ajax/libs/jquery/1.9.1/jquery.min.js"></script>
    <script src="bootstrap/js/bootstrap.min.js"></script>
    <script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false&libraries=visualization"></script>

    <script type="text/javascript">
        document.write('<script type="text/javascript" src="http://google-maps-utility-library-v3.googlecode.com/svn/trunk/markermanager/src/markermanager.js"><'+'/script>');
    </script>
    <script>


var map, pointarray, heatmap;
var heatmaps = {};
var defaultzoom = 4;
var defaultcentre = new google.maps.LatLng(-28.75,133.70);


function initialize() {
  var mapOptions = {
    zoom: defaultzoom,
    center: defaultcentre,
    mapTypeId: google.maps.MapTypeId.ROADMAP
  };

  map = new google.maps.Map(document.getElementById('map-canvas'),
      mapOptions);
	  
  manager = new MarkerManager(map);
  infowindow = new google.maps.InfoWindow({ content: "holding..."});


  loadParty("ALP", true);
  loadParty("FFP");
  loadParty("GRN");
  loadParty("LP");
  loadParty("LNP");
  loadParty("NP");
  loadParty("ON");
  loadParty("PUP");
  loadParty("RUA");


  toggleHeatmapParty("ALP");

  $("ul.partychange a").click(function(){
	  toggleHeatmapParty($(this).attr("data-party"));
	  $('ul.partychange li').removeClass('active');
	  $(this).parent('li').addClass('active');
   });
   
   $('#title').click(function(){
		revertMap();
	});	
	
	$('.moreinfo').click(function(){
		toggleInfo();
	});
	
  
   loadBooths();



}

function loadParty(party, show){

  if(!party) return;

  var data = $.getJSON('./data/' + party + '.json', function(json) {

	var partydata = [];

	for (var i=0; i < json.data.length; i++){
		if(json.data[i].count > 0){
			var line = {location: new google.maps.LatLng( json.data[i].lat, json.data[i].lng), weight: json.data[i].count}	;
			partydata.push(line);	
		}
	}

	
	  var gradient = [
    'rgba(0, 255, 255, 0)',
    'rgba(0, 255, 255, 1)',
    'rgba(0, 127, 255, 1)',
    'rgba(0, 63, 255, 1)',
    'rgba(0, 0, 255, 1)',
    'rgba(0, 0, 191, 1)',
    'rgba(0, 0, 159, 1)',
    'rgba(0, 0, 127, 1)',
    'rgba(127, 0, 63, 1)',
    'rgba(191, 0, 31, 1)',
    'rgba(255, 0, 0, 1)'
  ];
  

  
  
	heatmaps[party] = new google.maps.visualization.HeatmapLayer({
	   data: partydata ,
       opactity: 0.9,
	   maxIntensity: json.max,
	   radius: 20,
	   gradient: gradient,
	   dissipating: true 
	});

	if(show){
		heatmaps[party].setMap(map);
	}
	
  });
}

function revertMap(){
	map.setZoom(defaultzoom);
	map.setCenter(defaultcentre);
}


function toggleHeatmapParty(party){

	  $.each(heatmaps, function(key, value){
		if (key == party){
			value.setMap(map);
		}
		else{
			value.setMap(null);
		}
	  });
}

function toggleInfo(){
    $('.moreinfo').parent('li').toggleClass('active');
	$('#about').toggle();
	$('#map-canvas').toggleClass("lower");
}


function loadBooths(){
    $.getJSON("./data/booths.json", function(results){
	for (var i = 0; i < results.features.length; i++) {
	
		// build the html from the candidates properties
		var whtml =  "<h3>"+ results.features[i].properties.name + "</h3>";

		if(results.features[i].properties.candidates){
			for (var x=0; x < results.features[i].properties.candidates.length; x++){
				whtml+= "<p>" + results.features[i].properties.candidates[x] + "</p>";		
			}
		}

 		var coords = results.features[i].geometry.coordinates;
   		var latLng = new google.maps.LatLng(coords[1], coords[0]);
    		var marker = new google.maps.Marker({
      			position: latLng,
	   			title : results.features[i].properties.name,
			    html : whtml
			});
		google.maps.event.addListener(marker, 'click', function(){
			infowindow.setContent(this.html);
			infowindow.open(map, this);
		});

		manager.addMarker(marker, 13);

	} 			
	manager.refresh();
    });	
}

google.maps.event.addDomListener(window, 'load', initialize);

    </script>
  </head>

  <body>

<div class="navbar  navbar-fixed-top">
  <div class="navbar-inner">

 	<a class="btn btn-navbar" data-toggle="collapse" data-target=".nav-collapse">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </a>
    <a class="brand" id='title' href='#'>Election Heatmap</a>

  <div class="nav-collapse collapse">
  
      <a class="btn btn-small" href="#" data-party="ALP">ALP</a>
      <a class="btn btn-small" href="#" data-party="FFP">Family First</a>
      <a class="btn btn-small" href="#" data-party="GRN">Greens</a>
      <a class="btn btn-small" href="#" data-party="LP">Liberal</a>
      <a class="btn btn-small" href="#" data-party="LNP">LNP</a>
      <a class="btn btn-small" href="#" data-party="ON">One Nation</a>
      <a class="btn btn-small" href="#" data-party="NP">National</a>
      <a class="btn btn-small" href="#" data-party="PUP">Palmer</a>
      <a class="btn btn-small" href="#" data-party="RUA">Rise Up Australia</a>


      <a class="moreinfo" href="#">More Info</a>
      <div class="pull-right"><a class="brand" href="http://twitter.com/peterneish">@peterneish</a></div>
  </div>
 </div> 
</div>
	<div id="about" class="span-9" style="display: none;">
	<div class="container">
	<h3>About <a class="btn btn-primary btn-large moreinfo pull-right">Done</a></h3>
	<p>This map displays votes for parties as a <a href="http://en.wikipedia.org/wiki/Heat_map">heat map</a>. It uses data at the resolution of the polling booth rather than electorate.
    This means that you can zoom in to see how strong a vote was at an electorate.  If you zoom
	in far enough you can also click on individual booths to get exact percentages of first preferences for each candidate.
    </p>
	
	<h4>Limitations</h4>
	<p>Data is based on first preferences only. Because of the way heatmaps work, if booths are closer together the intensity increases, so to some extent the heat map is determined by the 
	layout of the booths. However, distinct patterns are discernible if you explore the data.
	</p>
	<p>Absentee voting at capital cities booths are mapped at the booth rather than in the electorate that the vote was for, so capital cities tend to show high results for every party.
	</p>
	<p>Data is taken from the <a href="http://www.aec.gov.au/media/mediafeed/">Australian Electoral Commission</a>.</p>
	
	
	

	<p>Written by <a href="http://twitter.com/peterneish">Peter Neish</a> and code is available at <a href="http://github.com/peterneish/booths">GitHub</a>.
	</p>
	</div>
	</div>
    <div id="map-canvas"></div>
	
	
	
	<noscript><img src="map.jpg">nothin to see here without javascript.</script>
	
	
  </body>
</html>
